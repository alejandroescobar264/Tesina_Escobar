---
title: "Dotplots"
author: "Escobar"
date: "2025-07-19"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(dplyr)
library(magrittr)
library(GenomicRanges)
library(knitr)
library(ggplot2)
library(tidyr)
library(fs)
library(glue)
library(stringr)
```

## Configuración
```{r}
# Directorios base
base_dir  <- "/home/alejandro/Documentos/Bioinfo/Tesina_Escobar/Analisis_R/dotplots"
ref_dir   <- file.path(base_dir, "referencia")  # Archivos de referencia: BMP2.fasta, RUNX2.fasta, etc.
query_dir <- file.path(base_dir, "fasta")       # Archivos de especies: mEumNan1.1.hap1_BMP2.fasta, etc.
out_dir   <- file.path(base_dir, "nucmer")
plots_dir <- file.path(out_dir, "plots")

dir_create(out_dir)
dir_create(plots_dir)

```

## Funciones para leer .delta
```{r}
readDelta <- function(deltafile){
  lines = scan(deltafile, 'a', sep='\n', quiet=TRUE)
  lines = lines[-1]
  lines.l = strsplit(lines, ' ')
  lines.len = lapply(lines.l, length) %>% as.numeric
  lines.l = lines.l[lines.len != 1]
  lines.len = lines.len[lines.len != 1]
  head.pos = which(lines.len == 4)
  head.id = rep(head.pos, c(head.pos[-1], length(lines.l)+1)-head.pos)
  mat = matrix(as.numeric(unlist(lines.l[lines.len==7])), 7)
  res = as.data.frame(t(mat[1:5,]))
  colnames(res) = c('rs','re','qs','qe','error')
  res$qid = unlist(lapply(lines.l[head.id[lines.len==7]], '[', 2))
  res$rid = unlist(lapply(lines.l[head.id[lines.len==7]], '[', 1)) %>% gsub('^>', '', .)
  res$strand = ifelse(res$qe-res$qs > 0, '+', '-')
  res
}
```


## Ejecutar nucmer para todos los genes y especies
```{r}
genes <- dir_ls(ref_dir, regexp = "\\.fasta$") %>%
  path_file() %>%
  str_remove("\\.fasta$")

all_deltas <- list()

for (gene in genes) {
  ref_file <- file.path(ref_dir, paste0(gene, ".fasta"))
  query_files <- dir_ls(query_dir, regexp = glue("{gene}\\.fasta$"))
  
  gene_results <- list()
  
  for (q in query_files) {
    species_name <- str_remove(path_file(q), "\\.fasta$")
    prefix <- file.path(out_dir, paste0(species_name, "_", gene))
    
    # Ejecutar NUCmer
    system(glue("nucmer --prefix={prefix} {ref_file} {q}"))
    
    delta_file <- paste0(prefix, ".delta")
    if (file_exists(delta_file)) {
      df <- readDelta(delta_file)
      df$Gene <- gene
      df$Species <- species_name
      
      # Calcular bases alineadas
      df <- df %>%
        group_by(Species) %>%
        mutate(total_aligned = sum(abs(qe - qs))) %>%
        ungroup()
      
      gene_results[[species_name]] <- df
    }
  }
  
  if (length(gene_results) > 0) {
    combined_df <- bind_rows(gene_results)
    
    # Ordenar especies por bases alineadas (sin filtrar ni diagonalizar)
    combined_df$Species <- factor(
      combined_df$Species,
      levels = unique(combined_df$Species)
    )
    
    all_deltas[[gene]] <- combined_df
  }
}

```

## Generar tabla de bases alineadas por especie y gen
```{r}
# Unir todos los resultados en un solo dataframe
alignment_summary <- bind_rows(all_deltas) %>%
  group_by(Gene, Species) %>%
  summarise(Total_Bases_Aligned = sum(abs(qe - qs)), .groups="drop") %>%
  arrange(Gene, desc(Total_Bases_Aligned))

# Guardar como CSV para referencia
write.csv(alignment_summary,
          file = file.path(out_dir, "Bases_Alineadas_Por_Gen_Especie.csv"),
          row.names = FALSE)

# Mostrar tabla en el reporte HTML
kable(alignment_summary, caption = "Cantidad de bases alineadas por especie y gen (NUCmer)")

```


## Graficar estilo mummerplot con ggplot2
```{r, results='asis'}
for (gene in names(all_deltas)) {
  df <- all_deltas[[gene]]
  if (nrow(df) == 0) next
  
  p <- ggplot(df, aes(x=rs, xend=re, y=qs, yend=qe, color=strand)) +
    geom_segment(size=1) +
    geom_point(alpha=0.4, size=1.5) +
    facet_wrap(~Species, ncol=2, scales="free_y") +
    theme_minimal(base_size = 10) +
    theme(
      plot.title = element_text(size=25, face="bold", hjust=0.5),
      axis.title = element_text(size=22, face="bold"),
      axis.text = element_text(size=22),
      legend.title = element_text(size=22, face="bold"),
      legend.text = element_text(size=20),
      strip.text = element_text(size=20, face="bold"),
      legend.position = "bottom",
      panel.grid.major = element_line(color="gray85"),
      panel.grid.minor = element_blank()
    ) +
    xlab(glue("Reference {gene} in Molossus molossus (bp)")) +
    ylab("Assembly (bp)") +
    ggtitle(glue("Dotplot for {gene}")) +
    scale_colour_brewer(palette='Set1', name="Strand")
  
  # Guardar PNG de cada gen
  ggsave(file.path(plots_dir, paste0(gene, "_dotplot.png")),
         p, width=18, height=22, dpi=300)
  
  # Insertar en el HTML final
  cat(glue("### {gene}\n\n"))
  cat(glue("![]({file.path(plots_dir, paste0(gene, '_dotplot.png'))})\n\n"))
}

```

## gen específico
```{r, fig.width=16, fig.height=9}
## ----------------------------------------------------------
## Dotplot para un gen y especie específicos (visualización directa)
## ----------------------------------------------------------

# Selección manual
gen_seleccionado <- "BMP7"  # Cambia por el gen que quieras
especie_seleccionada <- "mMolMol1.2.pri_BMP7"  # Cambia por la especie, o pon NA para todas

# Buscar el dataframe correspondiente al gen
if (!(gen_seleccionado %in% names(all_deltas))) {
  stop(glue("El gen '{gen_seleccionado}' no está disponible en los resultados."))
}

df_plot <- all_deltas[[gen_seleccionado]]

# Filtrar por especie si se indica
if (!is.na(especie_seleccionada)) {
  df_plot <- df_plot %>% filter(Species == especie_seleccionada)
}

if (nrow(df_plot) == 0) {
  stop("No hay datos para la combinación de gen y especie seleccionada.")
}

# Graficar
p <- ggplot(df_plot, aes(x = rs, xend = re, y = qs, yend = qe, color = strand)) +
  geom_segment(size = 1) +
  geom_point(alpha = 0.4, size = 1.5) +
  facet_wrap(~Species, ncol = 2, scales = "free_y") +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(size = 25, face = "bold", hjust = 0.5),
    axis.title = element_text(size = 22, face = "bold"),
    axis.text = element_text(size = 22),
    legend.title = element_text(size = 22, face = "bold"),
    legend.text = element_text(size = 20),
    strip.text = element_text(size = 20, face = "bold"),
    legend.position = "bottom",
    panel.grid.major = element_line(color = "gray85"),
    panel.grid.minor = element_line(color = "gray90", size = 0.3)
  ) +
  xlab(glue("Reference {gen_seleccionado} in Molossus molossus (bp)")) +
  ylab("Assembly (bp)") +
  ggtitle(glue("Dotplot for {gen_seleccionado}")) +
  scale_colour_brewer(palette = 'Set1', name = "Strand") +
  # Ajustar breaks para más líneas
  scale_x_continuous(breaks = seq(0, max(df_plot$rs, df_plot$re), by = 5000)) +
  scale_y_continuous(breaks = seq(0, max(df_plot$qs, df_plot$qe), by = 5000))

# Mostrar en RStudio
print(p)

```

